
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/generated/synth_data/fmm_tomography_regularization_discussion.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_generated_synth_data_fmm_tomography_regularization_discussion.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_generated_synth_data_fmm_tomography_regularization_discussion.py:


Seismic Wave Tomography via Fast Marching - Regularization Demo
===============================================================

.. GENERATED FROM PYTHON SOURCE LINES 9-14

|Open In Colab|

.. |Open In Colab| image:: https://img.shields.io/badge/open%20in-Colab-b5e2fa?logo=googlecolab&style=flat-square&color=ffd670
   :target: https://colab.research.google.com/github/inlab-geo/cofi-examples/blob/main/examples/fmm_tomography/fmm_tomography.ipynb


.. GENERATED FROM PYTHON SOURCE LINES 17-36

.. raw:: html

   <!-- Again, please don't touch the markdown cell above. We'll generate badge 
        automatically from the above cell. -->

.. raw:: html

   <!-- This cell describes things related to environment setup, so please add more text 
        if something special (not listed below) is needed to run this notebook -->

..

   If you are running this notebook locally, make sure you’ve followed
   `steps
   here <https://github.com/inlab-geo/cofi-examples#run-the-examples-with-cofi-locally>`__
   to set up the environment. (This
   `environment.yml <https://github.com/inlab-geo/cofi-examples/blob/main/envs/environment.yml>`__
   file specifies a list of packages required to run the notebooks)


.. GENERATED FROM PYTHON SOURCE LINES 39-54

.. raw:: html

   <!-- TODO - background introduction for this problem. -->

In this notebook, we would like to demonstrate the capability of CoFI to
easily switch between different types of regularizations.

We will use ``cofi`` to run a seismic wave tomography example, in which
the forward calculation is based on the Fast Marching Fortran code by
Nick Rawlinson. The Fast Marching code is wrapped in package
``espresso``.

We refer you to `fmm_tomography.ipynb <./fmm_tomography.ipynb>`__ for
further theretical details.


.. GENERATED FROM PYTHON SOURCE LINES 57-60

0. Import modules
-----------------


.. GENERATED FROM PYTHON SOURCE LINES 60-69

.. code-block:: default


    # -------------------------------------------------------- #
    #                                                          #
    #     Uncomment below to set up environment on "colab"     #
    #                                                          #
    # -------------------------------------------------------- #

    # !pip install -U cofi geo-espresso








.. GENERATED FROM PYTHON SOURCE LINES 71-79

.. code-block:: default


    import numpy as np
    import matplotlib.pyplot as plt
    import pprint

    import cofi
    import espresso








.. GENERATED FROM PYTHON SOURCE LINES 84-94

Understanding the inference problem
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Before we starting working with ``cofi``, let’s get familiar with the
problem itself.

Below is a plot of the true model and the paths generated from this
model. As you can see, there are two anomalies, one with lower velocity
(red, top left) and the other with higher velocity (blue, bottom right).


.. GENERATED FROM PYTHON SOURCE LINES 94-99

.. code-block:: default


    fmm = espresso.FmmTomography()

    fmm.plot_model(fmm.good_model, with_paths=True);




.. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_001.png
   :alt: fmm tomography regularization discussion
   :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

     New data set has:
     10  receivers
     10  sources
     100  travel times
     Range of travel times:  0.008911182496368759 0.0153757024856463 
     Mean travel time: 0.01085811731230709
    Trying to fix now...
    Execute permission given to fm2dss.o.

    <Axes: xlabel='x (km)', ylabel='y (km)'>



.. GENERATED FROM PYTHON SOURCE LINES 101-104

.. code-block:: default


    pprint.pprint(fmm.metadata)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    {'author_names': ['Nick Rawlinson', 'Malcolm Sambridge'],
     'citations': [('Rawlinson, N., de Kool, M. and Sambridge, M., 2006. Seismic '
                    'wavefront tracking in 3-D heterogeneous media: applications '
                    'with multiple data classes, Explor. Geophys., 37, 322-330.',
                    ''),
                   ('Rawlinson, N. and Urvoy, M., 2006. Simultaneous inversion of '
                    'active and passive source datasets for 3-D seismic structure '
                    'with application to Tasmania, Geophys. Res. Lett., 33 L24313',
                    '10.1029/2006GL028105'),
                   ('de Kool, M., Rawlinson, N. and Sambridge, M. 2006. A '
                    'practical grid based method for tracking multiple refraction '
                    'and reflection phases in 3D heterogeneous media, Geophys. J. '
                    'Int., 167, 253-270',
                    ''),
                   ('Saygin, E. 2007. Seismic receiver and noise correlation based '
                    'studies in Australia, PhD thesis, Australian National '
                    'University.',
                    '10.25911/5d7a2d1296f96')],
     'contact_email': 'Malcolm.Sambridge@anu.edu.au',
     'contact_name': 'Malcolm Sambridge',
     'linked_sites': [('Software published on iEarth',
                       'http://iearth.edu.au/codes/FMTOMO/')],
     'problem_short_description': 'The wave front tracker routines solves boundary '
                                  'value ray tracing problems into 2D '
                                  'heterogeneous wavespeed media, defined by '
                                  'continuously varying velocity model calculated '
                                  'by 2D cubic B-splines.',
     'problem_title': 'Fast Marching Wave Front Tracking'}




.. GENERATED FROM PYTHON SOURCE LINES 109-112

1. Problem setup and utilities
------------------------------


.. GENERATED FROM PYTHON SOURCE LINES 112-119

.. code-block:: default


    # get problem information from  espresso FmmTomography
    model_size = fmm.model_size         # number of model parameters
    model_shape = fmm.model_shape       # 2D spatial grids
    data_size = fmm.data_size           # number of data points
    ref_start_slowness = fmm.starting_model








.. GENERATED FROM PYTHON SOURCE LINES 121-141

.. code-block:: default


    def objective_func(slowness, reg, sigma):
        ttimes = fmm.forward(slowness)
        residual = fmm.data - ttimes
        data_misfit = residual.T @ residual / sigma**2
        model_reg = reg(slowness)
        return  data_misfit + model_reg

    def gradient(slowness, reg, sigma):
        ttimes, A = fmm.forward(slowness, with_jacobian=True)
        data_misfit_grad = -2 * A.T @ (fmm.data - ttimes) / sigma**2
        model_reg_grad = reg.gradient(slowness)
        return  data_misfit_grad + model_reg_grad

    def hessian(slowness, reg, sigma):
        A = fmm.jacobian(slowness)
        data_misfit_hess = 2 * A.T @ A / sigma**2 
        model_reg_hess = reg.hessian(slowness)
        return data_misfit_hess + model_reg_hess








.. GENERATED FROM PYTHON SOURCE LINES 146-152

2. Invert with quadratic smoothing and damping regularization terms
-------------------------------------------------------------------

2.1 Define BaseProblem
~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 152-157

.. code-block:: default


    # define CoFI BaseProblem
    fmm_problem_quadratic_reg = cofi.BaseProblem()
    fmm_problem_quadratic_reg.set_initial_model(ref_start_slowness)








.. GENERATED FROM PYTHON SOURCE LINES 159-174

.. code-block:: default


    # add regularization: damping + smoothing
    damping_factor = 50
    smoothing_factor = 5e3
    reg_damping = damping_factor * cofi.utils.QuadraticReg(
        model_shape=model_shape, 
        weighting_matrix="damping", 
        reference_model=ref_start_slowness
    )
    reg_smoothing = smoothing_factor * cofi.utils.QuadraticReg(
        model_shape=model_shape,
        weighting_matrix="smoothing"
    )
    reg = reg_damping + reg_smoothing








.. GENERATED FROM PYTHON SOURCE LINES 176-183

.. code-block:: default


    sigma =  0.00001                   # Noise is 1.0E-4 is ~5% of standard deviation of initial travel time residuals

    fmm_problem_quadratic_reg.set_objective(objective_func, args=[reg, sigma])
    fmm_problem_quadratic_reg.set_gradient(gradient, args=[reg, sigma])
    fmm_problem_quadratic_reg.set_hessian(hessian, args=[reg, sigma])








.. GENERATED FROM PYTHON SOURCE LINES 188-191

2.2 Define InversionOptions
~~~~~~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 191-198

.. code-block:: default


    my_options = cofi.InversionOptions()

    # cofi's own simple newton's matrix-based optimization solver
    my_options.set_tool("cofi.simple_newton")
    my_options.set_params(num_iterations=6, step_length=1, verbose=True)








.. GENERATED FROM PYTHON SOURCE LINES 203-206

2.3 Start an inversion
~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 206-211

.. code-block:: default


    inv = cofi.Inversion(fmm_problem_quadratic_reg, my_options)
    inv_result_quadratic_reg = inv.run()
    inv_result_quadratic_reg.summary()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Iteration #0, updated objective function value: 1787.077540309464
    Iteration #1, updated objective function value: 121.06987606708292
    Iteration #2, updated objective function value: 5.825780480486444
    Iteration #3, updated objective function value: 3.671788666778372
    Iteration #4, updated objective function value: 1.607554713000219
    Iteration #5, updated objective function value: 2.7445114317373114
    ============================
    Summary for inversion result
    ============================
    SUCCESS
    ----------------------------
    model: [0.00048381 0.00048191 0.00048029 ... 0.00050748 0.00050694 0.00050628]
    num_iterations: 5
    objective_val: 2.7445114317373114
    n_obj_evaluations: 7
    n_grad_evaluations: 6
    n_hess_evaluations: 6




.. GENERATED FROM PYTHON SOURCE LINES 216-219

2.4 Plotting
~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 219-223

.. code-block:: default


    fmm.plot_model(inv_result_quadratic_reg.model);            # inverted model
    fmm.plot_model(fmm.good_model);       # true model




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_002.png
         :alt: fmm tomography regularization discussion
         :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_003.png
         :alt: fmm tomography regularization discussion
         :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_003.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    <Axes: xlabel='x (km)', ylabel='y (km)'>



.. GENERATED FROM PYTHON SOURCE LINES 228-246

--------------

3. Invert with Gaussian prior as regularization term
----------------------------------------------------

Instead of using a smoothing and damping regularization, in this
section, we use a model covariance matrix and prior model.

:math:`\chi_{P}^{2}=\left(\mathbf{y} -\mathbf{f}(\mathbf{m})\right)^T C_d^{-1} \left(\mathbf{y} -\mathbf{f}(\mathbf{m})\right) + \left( \mathbf{m} - \mathbf{m}_p \right)^T C_p^{-1} \left( \mathbf{m} - \mathbf{m}_p \right)`

:math:`\Delta \mathbf{m}= ({J}^T {C}_d^{-1} {J}+{C}_p^{-1})^{-1} ({J}^T{C}_d^{-1} (\mathbf{y}-\mathbf{f}(\mathbf{m}))+{C}_p^{-1}(\mathbf{m}_p-\mathbf{m}))`

We can use CoFI’s utility module to help us generate a the Gaussian
prior term.

3.1 Define BaseProblem
~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 246-251

.. code-block:: default


    # define CoFI BaseProblem
    fmm_problem_gaussian_prior = cofi.BaseProblem()
    fmm_problem_gaussian_prior.set_initial_model(ref_start_slowness)








.. GENERATED FROM PYTHON SOURCE LINES 253-263

.. code-block:: default


    # add regularization: Gaussian prior
    corrx = 3.0
    corry = 3.0
    sigma_slowness = 0.002
    gaussian_prior = cofi.utils.GaussianPrior(
        model_covariance_inv=((corrx, corry), sigma_slowness),
        mean_model=ref_start_slowness.reshape(model_shape)
    )








.. GENERATED FROM PYTHON SOURCE LINES 265-270

.. code-block:: default


    fmm_problem_gaussian_prior.set_objective(objective_func, args=[gaussian_prior, sigma])
    fmm_problem_gaussian_prior.set_gradient(gradient, args=[gaussian_prior, sigma])
    fmm_problem_gaussian_prior.set_hessian(hessian, args=[gaussian_prior, sigma])








.. GENERATED FROM PYTHON SOURCE LINES 275-278

3.2 Start an inversion
~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 278-284

.. code-block:: default


    # reuse the previously defined InversionOptions object
    inv = cofi.Inversion(fmm_problem_gaussian_prior, my_options)
    inv_result_gaussian_prior = inv.run()
    inv_result_gaussian_prior.summary()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Iteration #0, updated objective function value: 2506.4853690587847
    Iteration #1, updated objective function value: 1024.9309152365797
    Iteration #2, updated objective function value: 977.4811110047494
    Iteration #3, updated objective function value: 976.6662653781226
    Iteration #4, updated objective function value: 975.999885790021
    Iteration #5, updated objective function value: 976.2098353866515
    ============================
    Summary for inversion result
    ============================
    SUCCESS
    ----------------------------
    model: [0.00049665 0.00049542 0.00049382 ... 0.00050314 0.0005023  0.00050166]
    num_iterations: 5
    objective_val: 976.2098353866515
    n_obj_evaluations: 7
    n_grad_evaluations: 6
    n_hess_evaluations: 6




.. GENERATED FROM PYTHON SOURCE LINES 289-292

3.3 Plotting
~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 292-296

.. code-block:: default


    fmm.plot_model(inv_result_gaussian_prior.model);            # inverted model
    fmm.plot_model(fmm.good_model);       # true model




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_004.png
         :alt: fmm tomography regularization discussion
         :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_004.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_005.png
         :alt: fmm tomography regularization discussion
         :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_005.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    <Axes: xlabel='x (km)', ylabel='y (km)'>



.. GENERATED FROM PYTHON SOURCE LINES 301-306

4. Comparison and discussion
----------------------------

#TODO


.. GENERATED FROM PYTHON SOURCE LINES 306-310

.. code-block:: default


    fmm.plot_model(inv_result_quadratic_reg.model);
    fmm.plot_model(inv_result_gaussian_prior.model);




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_006.png
         :alt: fmm tomography regularization discussion
         :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_006.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_007.png
         :alt: fmm tomography regularization discussion
         :srcset: /examples/generated/synth_data/images/sphx_glr_fmm_tomography_regularization_discussion_007.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    <Axes: xlabel='x (km)', ylabel='y (km)'>



.. GENERATED FROM PYTHON SOURCE LINES 315-328

--------------

Watermark
---------

.. raw:: html

   <!-- Feel free to add more modules in the watermark_list below, if more packages are used -->

.. raw:: html

   <!-- Otherwise please leave the below code cell unchanged -->


.. GENERATED FROM PYTHON SOURCE LINES 328-334

.. code-block:: default


    watermark_list = ["cofi", "espresso", "numpy", "matplotlib"]
    for pkg in watermark_list:
        pkg_var = __import__(pkg)
        print(pkg, getattr(pkg_var, "__version__"))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    cofi 0.2.2
    espresso 0.3.9
    numpy 1.24.3
    matplotlib 3.7.1




.. GENERATED FROM PYTHON SOURCE LINES 335-335

sphinx_gallery_thumbnail_number = -1


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  52.563 seconds)


.. _sphx_glr_download_examples_generated_synth_data_fmm_tomography_regularization_discussion.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: fmm_tomography_regularization_discussion.py <fmm_tomography_regularization_discussion.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: fmm_tomography_regularization_discussion.ipynb <fmm_tomography_regularization_discussion.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
